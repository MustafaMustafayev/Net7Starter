<?xml version="1.0" encoding="utf-8"?>

<nlog
        xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
        autoReload="true"
        internalLogLevel="Trace"
        internalLogFile="${basedir}/wwwroot/Logs/internallog.txt">
    <extensions>
        <add assembly="NLog.Web.AspNetCore"/>
        <add assembly="NLog.Database"/>
    </extensions>

    <targets>
        <target name="db" type="Database" dbProvider="Npgsql.NpgsqlConnection, Npgsql">
            <connectionString>
                ${configsetting:item=Config.ConnectionStrings.AppDb}
            </connectionString>
            <commandText>
                insert into public."NLogs" ("Application", "LogDate", "Level", "Message", "Logger", "CallSite", "Exception")
                values (@Application, TO_TIMESTAMP( @LogDate, 'YYYY-MM-DD HH24:MI:SS'), @Level, @Message, @Logger, @Callsite, @Exception);
            </commandText>
            <parameter name="@Application" layout="EPORTAL"/>
            <parameter name="@LogDate" layout="${date}"/>
            <parameter name="@Level" layout="${level:upperCase=true}"/>
            <parameter name="@Message" layout="${message}"/>
            <parameter name="@Logger" layout="${logger}"/>
            <parameter name="@CallSite" layout="${callsite:filename=true}"/>
            <parameter name="@Exception" layout="${exception:tostring}"/>
        </target>

        <target name='jsonFile' type='File' fileName='${basedir}/wwwroot/Logs/${shortdate}_logfile.json'>
            <layout type='JsonLayout'>
                <attribute name='time' layout='${longdate}'/>
                <attribute name='level' layout='${level:upperCase=true}'/>
                <attribute name='Properties' encode='false'>
                    <layout type='JsonLayout'>
                        <attribute name='message' layout='${message}'/>
                        <attribute name='exception' layout='${exception}'/>
                    </layout>
                </attribute>
            </layout>
        </target>

    </targets>

    <rules>
        <logger name="*" minlevel="Error" writeTo="db"/>
        <logger name="*" minlevel="Debug" writeTo="jsonFile"/>
    </rules>
</nlog>